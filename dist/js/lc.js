"use strict";!function(){function a(a,b){return[a[0]*b[0]+a[1]*b[3],a[0]*b[1]+a[1]*b[4],a[0]*b[2]+a[1]*b[5]+a[2],a[3]*b[0]+a[4]*b[3],a[3]*b[1]+a[4]*b[4],a[3]*b[2]+a[4]*b[5]+a[5]]}function b(){for(var b=a(arguments[0],arguments[1]),c=2;c<arguments.length;c++)b=a(b,arguments[c]);return b}function c(a,b){return[a[0]*b[0]+a[1]*b[1]+a[2],a[3]*b[0]+a[4]*b[1]+a[5]]}function d(a){return[1,0,a[0],0,1,a[1]]}function e(a){return[a,0,0,0,a,0]}function f(a){var b=Math.cos(a),c=Math.sin(a);return[b,c,0,-c,b,0]}function g(a,b,c,d,e,f){return[2/(b-a),0,0,0,0,2/(c-d),0,0,0,0,2/(e-f),0,-(b+a)/(b-a),-(c+d)/(c-d),-(f+e)/(f-e),1]}function h(a){this.width=a.naturalWidth,this.height=a.naturalHeight,this.texture=y.createTexture(),y.bindTexture(y.TEXTURE_2D,this.texture),y.texImage2D(y.TEXTURE_2D,0,y.RGBA,y.RGBA,y.UNSIGNED_BYTE,a),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.LINEAR),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.LINEAR_MIPMAP_LINEAR),y.generateMipmap(y.TEXTURE_2D),y.bindTexture(y.TEXTURE_2D,null)}function i(a,b){this.texture=a,this.frame={x:b.x/a.width,y:b.y/a.height,width:b.w/a.width,height:b.h/a.height},this.aspect=b.w/b.h}function j(a){return new Promise(function(b,c){var d=new Promise(function(b,c){var d=new Image;d.onload=function(){var a=new h(d);s.push(a),b(a)},d.onerror=c,d.src=a+".png"}),e=fetch(a+".json").then(function(a){return a.json()});Promise.all([d,e]).then(function(a){var c=a[0],d=a[1];for(var e in d)t[e]=new i(c,d[e]);b()})["catch"](c)})}function k(a){var b={alpha:!1,depth:!1,stencil:!1,preserveDrawingBuffer:!1};return a.getContext("webgl",b)||a.getContext("experimental-webgl",b)}function l(a,b){var c=y.createShader(b);return y.shaderSource(c,a),y.compileShader(c),y.getShaderParameter(c,y.COMPILE_STATUS)||console.error(y.getShaderInfoLog(c)),c}function m(a,b){var c=y.createProgram();return y.attachShader(c,a),y.attachShader(c,b),y.linkProgram(c),y.getProgramParameter(c,y.LINK_STATUS)||console.error(y.getProgramInfoLog(c)),c}function n(){var a=l(u,y.VERTEX_SHADER),b=l(v,y.FRAGMENT_SHADER),c=m(a,b);return{program:c,aPosition:y.getAttribLocation(c,"a_position"),aTexCoord:y.getAttribLocation(c,"a_texCoord"),aColor:y.getAttribLocation(c,"a_color"),uTransform:y.getUniformLocation(c,"u_transform"),uTexture:y.getUniformLocation(c,"u_texture")}}function o(){this.VERTEX_SIZE=8,this.BATCH_SIZE=128,this.batchIndex=0,this.vertexData=new Float32Array(this.BATCH_SIZE*this.VERTEX_SIZE*4),this.vertexBuffer=y.createBuffer(),this.indexBuffer=y.createBuffer(),w||(w=n()),this.transform=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);for(var a=new Uint16Array(6*this.BATCH_SIZE),b=0,c=0;c<this.BATCH_SIZE;c+=6)a[c+0]=b+0,a[c+1]=b+1,a[c+2]=b+2,a[c+3]=b+2,a[c+4]=b+1,a[c+5]=b+3,b+=4;y.bindBuffer(y.ELEMENT_ARRAY_BUFFER,this.indexBuffer),y.bufferData(y.ELEMENT_ARRAY_BUFFER,a,y.STATIC_DRAW),this.texture=null}function p(){this.x=0,this.y=5,this.dy=0,this.gravity=10,this.speed=20}function q(){this.player=new p}function r(){y.clearColor(100/255,149/255,237/255,1),y.clear(y.COLOR_BUFFER_BIT|y.DEPTH_BUFFER_BIT),z.tick(.016,A),z.render(),(z.player.y<0||z.player.y>10)&&(z=new q,z.renderInit()),window.requestAnimationFrame(r)}!function(){function a(a){if("string"!=typeof a&&(a=String(a)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(a))throw new TypeError("Invalid character in header field name");return a.toLowerCase()}function b(a){return"string"!=typeof a&&(a=String(a)),a}function c(a){this.map={},a instanceof c?a.forEach(function(a,b){this.append(b,a)},this):a&&Object.getOwnPropertyNames(a).forEach(function(b){this.append(b,a[b])},this)}function d(a){return a.bodyUsed?Promise.reject(new TypeError("Already read")):void(a.bodyUsed=!0)}function e(a){return new Promise(function(b,c){a.onload=function(){b(a.result)},a.onerror=function(){c(a.error)}})}function f(a){var b=new FileReader;return b.readAsArrayBuffer(a),e(b)}function g(a){var b=new FileReader;return b.readAsText(a),e(b)}function h(){return this.bodyUsed=!1,this._initBody=function(a){if(this._bodyInit=a,"string"==typeof a)this._bodyText=a;else if(n.blob&&Blob.prototype.isPrototypeOf(a))this._bodyBlob=a;else if(n.formData&&FormData.prototype.isPrototypeOf(a))this._bodyFormData=a;else if(a){if(!n.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(a))throw new Error("unsupported BodyInit type")}else this._bodyText=""},n.blob?(this.blob=function(){var a=d(this);if(a)return a;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this.blob().then(f)},this.text=function(){var a=d(this);if(a)return a;if(this._bodyBlob)return g(this._bodyBlob);if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)}):this.text=function(){var a=d(this);return a?a:Promise.resolve(this._bodyText)},n.formData&&(this.formData=function(){return this.text().then(k)}),this.json=function(){return this.text().then(JSON.parse)},this}function i(a){var b=a.toUpperCase();return o.indexOf(b)>-1?b:a}function j(a,b){b=b||{};var d=b.body;if(j.prototype.isPrototypeOf(a)){if(a.bodyUsed)throw new TypeError("Already read");this.url=a.url,this.credentials=a.credentials,b.headers||(this.headers=new c(a.headers)),this.method=a.method,this.mode=a.mode,d||(d=a._bodyInit,a.bodyUsed=!0)}else this.url=a;if(this.credentials=b.credentials||this.credentials||"omit",(b.headers||!this.headers)&&(this.headers=new c(b.headers)),this.method=i(b.method||this.method||"GET"),this.mode=b.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&d)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(d)}function k(a){var b=new FormData;return a.trim().split("&").forEach(function(a){if(a){var c=a.split("="),d=c.shift().replace(/\+/g," "),e=c.join("=").replace(/\+/g," ");b.append(decodeURIComponent(d),decodeURIComponent(e))}}),b}function l(a){var b=new c,d=a.getAllResponseHeaders().trim().split("\n");return d.forEach(function(a){var c=a.trim().split(":"),d=c.shift().trim(),e=c.join(":").trim();b.append(d,e)}),b}function m(a,b){b||(b={}),this._initBody(a),this.type="default",this.status=b.status,this.ok=this.status>=200&&this.status<300,this.statusText=b.statusText,this.headers=b.headers instanceof c?b.headers:new c(b.headers),this.url=b.url||""}if(!self.fetch){c.prototype.append=function(c,d){c=a(c),d=b(d);var e=this.map[c];e||(e=[],this.map[c]=e),e.push(d)},c.prototype["delete"]=function(b){delete this.map[a(b)]},c.prototype.get=function(b){var c=this.map[a(b)];return c?c[0]:null},c.prototype.getAll=function(b){return this.map[a(b)]||[]},c.prototype.has=function(b){return this.map.hasOwnProperty(a(b))},c.prototype.set=function(c,d){this.map[a(c)]=[b(d)]},c.prototype.forEach=function(a,b){Object.getOwnPropertyNames(this.map).forEach(function(c){this.map[c].forEach(function(d){a.call(b,d,c,this)},this)},this)};var n={blob:"FileReader"in self&&"Blob"in self&&function(){try{return new Blob,!0}catch(a){return!1}}(),formData:"FormData"in self,arrayBuffer:"ArrayBuffer"in self},o=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];j.prototype.clone=function(){return new j(this)},h.call(j.prototype),h.call(m.prototype),m.prototype.clone=function(){return new m(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new c(this.headers),url:this.url})},m.error=function(){var a=new m(null,{status:0,statusText:""});return a.type="error",a};var p=[301,302,303,307,308];m.redirect=function(a,b){if(-1===p.indexOf(b))throw new RangeError("Invalid status code");return new m(null,{status:b,headers:{location:a}})},self.Headers=c,self.Request=j,self.Response=m,self.fetch=function(a,b){return new Promise(function(c,d){function e(){return"responseURL"in g?g.responseURL:/^X-Request-URL:/m.test(g.getAllResponseHeaders())?g.getResponseHeader("X-Request-URL"):void 0}var f;f=j.prototype.isPrototypeOf(a)&&!b?a:new j(a,b);var g=new XMLHttpRequest;g.onload=function(){var a=1223===g.status?204:g.status;if(100>a||a>599)return void d(new TypeError("Network request failed"));var b={status:a,statusText:g.statusText,headers:l(g),url:e()},f="response"in g?g.response:g.responseText;c(new m(f,b))},g.onerror=function(){d(new TypeError("Network request failed"))},g.open(f.method,f.url,!0),"include"===f.credentials&&(g.withCredentials=!0),"responseType"in g&&n.blob&&(g.responseType="blob"),f.headers.forEach(function(a,b){g.setRequestHeader(b,a)}),g.send("undefined"==typeof f._bodyInit?null:f._bodyInit)})},self.fetch.polyfill=!0}}();var s=[],t={},u="\n\nprecision mediump float;\n\nuniform mat4 u_transform;\n\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\n\nvarying vec2 v_texCoord;\nvarying vec4 v_color;\n\nvoid main() {\n	gl_Position = u_transform * a_position;\n	v_texCoord = a_texCoord;\n	v_color = a_color;\n}\n\n",v="\n\nprecision mediump float;\n\nuniform sampler2D u_texture;\n\nvarying vec2 v_texCoord;\nvarying vec4 v_color;\n\nvoid main() {\n	gl_FragColor = texture2D(u_texture, v_texCoord);\n}\n\n",w=null;o.prototype.draw=function(a,b,d){(this.texture!=a.texture||this.batchIndex==this.BATCH_SIZE)&&this.flush(),d||(d={r:1,g:1,b:1,a:1}),this.texture=a.texture;for(var e=4*this.batchIndex*this.VERTEX_SIZE,f=a.frame,g=[[-.5,.5],[.5,.5],[-.5,-.5],[.5,-.5]],h=[[f.x,f.y],[f.x+f.width,f.y],[f.x,f.y+f.height],[f.x+f.width,f.y+f.height]],i=0;4>i;i++){var j=h[i],k=c(b,g[i]);this.vertexData[e+0]=k[0],this.vertexData[e+1]=k[1],this.vertexData[e+2]=j[0],this.vertexData[e+3]=j[1],this.vertexData[e+4]=d.r,this.vertexData[e+5]=d.g,this.vertexData[e+6]=d.b,this.vertexData[e+7]=d.a,e+=this.VERTEX_SIZE}this.batchIndex+=1},o.prototype.flush=function(){if(this.batchIndex>0){var a=this.batchIndex*this.VERTEX_SIZE*4,b=this.vertexData.subarray(0,a),c=w;y.enable(y.BLEND),y.blendFunc(y.ONE,y.ONE_MINUS_SRC_ALPHA),y.bindBuffer(y.ELEMENT_ARRAY_BUFFER,this.indexBuffer),y.bindBuffer(y.ARRAY_BUFFER,this.vertexBuffer),y.bufferData(y.ARRAY_BUFFER,b,y.STREAM_DRAW),y.useProgram(c.program),y.enableVertexAttribArray(0),y.enableVertexAttribArray(1),y.enableVertexAttribArray(2),y.activeTexture(y.TEXTURE0+0),y.bindTexture(y.TEXTURE_2D,this.texture.texture),y.uniformMatrix4fv(c.uTransform,!1,this.transform),y.uniform1i(c.uTexture,0);var d=4*this.VERTEX_SIZE;y.vertexAttribPointer(c.aPosition,2,y.FLOAT,y.FALSE,d,0),y.vertexAttribPointer(c.aTexCoord,2,y.FLOAT,y.FALSE,d,8),y.vertexAttribPointer(c.aColor,4,y.FLOAT,y.FALSE,d,16);var e=6*this.batchIndex;y.drawElements(y.TRIANGLES,e,y.UNSIGNED_SHORT,0)}this.batchIndex=0,this.texture=null},p.prototype.tick=function(a,b){this.dy-=this.gravity*a,b.up&&(this.dy+=this.speed*a),this.y+=this.dy*a},q.prototype.tick=function(a,b){this.player.tick(a,b)},q.prototype.renderInit=function(){this.spriteBatch=new o},q.prototype.render=function(){var c=this.player.y,h=800/600;this.spriteBatch.transform=new Float32Array(g(0,10*h,10,0,-1,1));var i=b(d([4,c]),f(.05*-this.player.dy),e(2)),j=t["head/base/normal.png"];this.spriteBatch.draw(j,a(i,[j.aspect,0,0,0,1,0]));var k=t["head/rotor/normal.png"];this.spriteBatch.draw(k,a(i,[.5,0,-.03,0,1/k.aspect*.5,.43])),this.spriteBatch.flush()};var x=document.getElementById("game_canvas"),y=k(x),z=new q;z.renderInit();var A={up:!1};document.addEventListener("keydown",function(a){switch(a.keyCode){case 38:A.up=!0}}),document.addEventListener("keyup",function(a){switch(a.keyCode){case 38:A.up=!1}}),document.addEventListener("touchstart",function(a){return A.up=!0,a.preventDefault(),!1}),document.addEventListener("touchend",function(a){return A.up=!1,a.preventDefault(),!1}),j("data/atlas").then(function(){window.requestAnimationFrame(r)})}();